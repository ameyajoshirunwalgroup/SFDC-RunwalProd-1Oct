name: Salesforce Code Analyzer

on:
  pull_request:
    branches:
      - fullcopy
      - main
    types: [opened, synchronize, reopened]
    paths:
      - 'force-app/**'

jobs:
  salesforce-code-analyzer:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.9.0'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache NPM & SF Plugin Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.local/lib
            ~/.local/share/sf
            /usr/local/lib/node_modules/@salesforce
            /usr/local/lib/node_modules/@oclif
          key: npm-sfcli-${{ runner.os }}-v3-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-sfcli-${{ runner.os }}-v3-
            npm-sfcli-
      - name: Install Salesforce CLI & Code Analyzer (if not cached)
        run: |
          if ! command -v sf &> /dev/null || ! sf plugins --core | grep -q "code-analyzer"; then
            echo "Installing Salesforce CLI and/or Code Analyzer plugin..."
            npm install -g @salesforce/cli@2.42.4
            sf plugins install code-analyzer@5.2.2
          else
            echo "âœ… Salesforce CLI & Code Analyzer are already installed via cache."
          fi
            
      - name: Run Code Analyzer on Changed Files Only
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

          echo "Comparing changes between origin/$BASE_BRANCH and HEAD"
          git fetch origin $BASE_BRANCH

          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD)
          FILES_TO_SCAN=$(echo "$CHANGED_FILES" | paste -sd "," -)

          echo "Files to analyze: $FILES_TO_SCAN"
          if [ -z "$FILES_TO_SCAN" ]; then
            echo "{}" > sfca_results.json
          else
            CODE_ANALYZER_CONFIG=./github/config/.scanner-config.json npx sf code-analyzer run --target "$FILES_TO_SCAN" --output-file sfca_results.json
          fi

      - name: Detect and Report Violations
        id: analyzer-check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          jq '.violations | map(select(.severity <= 3))' sfca_results.json > filtered_violations.json
          count=$(jq 'length' filtered_violations.json)

          if [ "$count" -gt 0 ]; then
            echo "âš ï¸ Found $count serious violations."
            echo "has-violations=true" >> $GITHUB_OUTPUT

            echo "## âš ï¸ Salesforce Code Analyzer Results (Severity 1-3)" > pr_comment.txt
            echo "" >> pr_comment.txt
            echo "| File | Line | Severity | Rule | Message |" >> pr_comment.txt
            echo "|------|------|----------|------|---------|" >> pr_comment.txt

            jq -r '
              .[] |
              [
                (.locations[0].file // "N/A"),
                (.locations[0].startLine // 1 | tostring),
                ("Severity " + (.severity | tostring)),
                .rule,
                (.message | gsub("\\|"; "\\|"))
              ] |
              "| " + join(" | ") + " |"
            ' filtered_violations.json >> pr_comment.txt

            echo -e "\n**ðŸŸ¥ Total Serious Violations:** $count\n" >> pr_comment.txt
            gh pr comment ${{ github.event.pull_request.number }} --body-file pr_comment.txt

            jq -r '
              .[] |
              "::warning file=\(.locations[0].file),line=\(.locations[0].startLine // 1)::{[Severity \(.severity)]} \(.rule): \(.message)"
            ' filtered_violations.json
          else
            echo "âœ… No high/medium violations found."
            echo "has-violations=false" >> $GITHUB_OUTPUT
          fi
