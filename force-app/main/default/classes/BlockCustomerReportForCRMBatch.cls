global class BlockCustomerReportForCRMBatch implements Database.Batchable<sObject>,Schedulable {

    private OrgWideEmailAddress fromAddress;

    global BlockCustomerReportForCRMBatch() {

        List<OrgWideEmailAddress> owe = [
            SELECT Id
            FROM OrgWideEmailAddress
            WHERE Address = 'customer.care@runwalgroup.in'
            LIMIT 1
        ];
        if (!owe.isEmpty()) {
            fromAddress = owe[0];
        }
    }

    global Database.QueryLocator start(Database.BatchableContext bc) {

        return Database.getQueryLocator([
            SELECT Id,Project_Account_Team_Email__c from Project__c where Project_Account_Team_Email__c!=null
        ]);
    }

    
    global void execute(Database.BatchableContext bc, List<Project__c> scope){
        
        if(!scope.isEmpty()){
            Set<Id> projId = new Set<Id>();
            for(Project__c proj: scope){
                projId.add(proj.id);
            }
            Map<Id, Project__c> mapOfIdProject = new Map<Id,Project__c>(scope);
            List<Opportunity> oppList = [Select id from Opportunity where RW_Project__c IN: projId and SAP_Customer_Number__c != NULL AND Id NOT IN (
                    SELECT Opportunity__c
                    FROM RW_Payment_Details__c) ];
        
            Set<Id> oppIds = new Set<Id>();
            for (Opportunity opp : oppList) {
                 oppIds.add(opp.Id);
            }
            
            List<Messaging.SingleEmailMessage> emailsToSend = new List<Messaging.SingleEmailMessage>();
            List<Receipt__c> receiptLst = [Select Id,Name,Mode__c,Cheque_DD__c,Total_Amount__c,Account_Recon__c,DraweeBank__c,Opportunity__r.RW_Agreement_Value__c,Opportunity__c,Opportunity__r.Name,Opportunity__r.RW_Project__r.Name,Project_Unit__r.Name,SAP_Customer_Number__c,Cheque_DD_Date__c,Drawn_in_favour_of__c from Receipt__c where Opportunity__c=:oppIds limit 50000];
            Map<String, String> projectToEmailMap = new Map<STring, String>();
            Map<String, List<Receipt__c>> projectReceiptMap = new Map<String, List<Receipt__c>>();
    
    
            for(Receipt__c receipt : receiptLst){
                String projectId = receipt.Opportunity__r.RW_Project__r.Id;
    
                if (projectId != null) {
                    if (!projectReceiptMap.containsKey(projectId)) {
                        projectReceiptMap.put(projectId, new List<Receipt__c>());
                    }
                    projectReceiptMap.get(projectId).add(receipt);
                }
            }
    
            System.debug('projectReceiptMap**'+projectReceiptMap);
            for (String projectId : projectReceiptMap.keySet()) {
                List<Receipt__c> receipts = projectReceiptMap.get(projectId);
                String projectName = receipts[0].Opportunity__r.RW_Project__r.Name;
                String emails = mapOfIdProject.get(projectId).Project_Account_Team_Email__c;
                
                String csvContent = 'Project,Project Unit,Opportunity,SAP Customer Number,Receipt Name,Instrument,Cheque/DD No,Total Amount,Drawee Bank,Account Recon,Drawn in favour of,Date,Agreement Value\n';
                for (Receipt__c r : receipts) {
                     csvContent += '"' + r.Opportunity__r.RW_Project__r.Name + '","' +
                                      (r.Project_Unit__r != null ? r.Project_Unit__r.Name : '') + '","' +
                                      r.Opportunity__r.Name + '","' +
                                      r.SAP_Customer_Number__c + '","' +
                                      r.Name + '","' +
                                      r.Mode__c + '","' +
                                      r.Cheque_DD__c + '","' +
                                      r.Total_Amount__c + '","' +
                                      r.DraweeBank__c + '","' +
                                      r.Account_Recon__c + '","' +
                                      r.Drawn_in_favour_of__c + '","' +
                                      r.Cheque_DD_Date__c + '","' +
                                      r.Opportunity__r.RW_Agreement_Value__c + '"\n';
                }
    
                Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
                attachment.setFileName(projectName + '_Receipt_Report.csv');
                attachment.setBody(Blob.valueOf(csvContent));
                attachment.setContentType('text/csv');
    
                // Create Email
                Messaging.SingleEmailMessage mail = new Messaging.SingleEmailMessage();
                if(fromAddress!=null){
                    mail.setOrgWideEmailAddressId(fromAddress.Id);
                }
                mail.setToAddresses(emails.split(','));
                mail.setSubject('Project Receipt Report - ' + projectName);
                mail.setPlainTextBody('Please find attached the latest receipt report for project: ' + projectName);
                mail.setFileAttachments(new Messaging.EmailFileAttachment[] { attachment });
                emailsTosend.add(mail);
            }
            if (!emailsTosend.isEmpty()) {
                Messaging.sendEmail(emailsTosend);
            }
        }
    }

    global void finish(Database.BatchableContext bc) {
        System.debug('Block Customer Receipt Report Batch completed.');
    }

    global void execute(SchedulableContext sc) {
        Database.executeBatch(new BlockCustomerReportForCRMBatch(), 1);
    }
    Public static void Dummy(){
        integer i=0;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
    }
}